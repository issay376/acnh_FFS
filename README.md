# acnh_FFS
AC:NH Flower Field Simulator

あつまれ　どうぶつの森　花の交配シミュレーター

        Animal Crossing New Horizon - Flower Field Simulator
        ver. 0.1        2020/06/10


## 作成の目的

本作では、交配時にランダムにペアが組まれ、ペアを組めなかった場合はクローンができる仕様のため、どの花の配置
と交配手順が優れているかは、簡単にはわかりません。（特に一般に行われている斜め格子状の配置は問題が多い）
そのため、シミュレーターで多数の試行を行なって、統計的に比較をしたいというのが作成の目的です。


## 謝辞

以下のサイトやインターネット上の情報がなければ、シミュレーターは作成できませんでした。
すべての情報を提供してくださった方、見やすく加工してくださった方、サイトを維持されている方々に感謝を
申し上げます。

        Special Thanks to all Dataminers, Analizers, Illustrators,
        and Site Managers, related the following sites and infomation.

　・AC:NH Flower Mechanics Ultimate Chart (Twitter: @_ninji, @aiterusawato）
　・Paleh's ACNH Flower Genetics Guide
　・あつまれどうぶつの森攻略｜hyperWiki（https://hyperwiki.jp/acnh/flowergene/）


## ライセンス

シミュレーターのコードおよびドキュメントは、GPL3.0で公開します。
完全に無保証で、自由に改変、配布を行なっていただいてかまいません。


## 構成

かんたんに比較をするためには、高速に試行を繰り返す必要があるため、C++で記述されています。

シミュレーションに必要な情報と機能（花の種類、色、遺伝子、成長段階、交配処理、基本の花畑、
植込順の定義、収穫時の移植先の定義、水やり、AM5:00の更新処理、連携機能を持つ花畑の定義、
基本のシミュレーター、繰返し試行と簡単な統計、など）は acnh.h にまとめられています。

現状ではシミュレーション・モデルはC++でコーディングする形になります。上記のツールを使って、
以下のようなシミュレーターを作ってありますので、自作する際に参考にしてください。

　・青バラをつくるための代表的な手順を検証するためのシミュレータ
        BackwardsN Method とその改良版
        Paleh Method
        Guaranteed Hybrid Red Methodとその改良版

　・5x3単位の花畑のレイアウトの検証（交配数、交配率、クローン数と出現率）
        おなじ遺伝子をもつ花のレイアウト
        ことなる遺伝子をもつ2種類の花のレイアウト

　・水やりと収穫の関係の検証
        1輪のクローンにかかる日数


## ユーティリティ（acnh.h）の特徴

### 1. Flower Mechanics Ultimate Chartの手順を再現

        たとえば、収穫したばかりのつぼみの花を交配につかった場合、一定の確率でクローンができて
        しまう（収穫したつぼみと相手の花の交配順序がどう抽選されるかで結果が異なる）といった、
        かなり微妙な問題まで、正確に再現できます。

### 2. 8種類すべての花と金のバラに対応

        たとえば、ペア交配で、異種の混ぜ植えをおこなうと、スペース効率があがることが検証できます。
        花は1.の手順を再現するために、種類、遺伝子、色だけでなく、芽から花までの成長段階や、
        水やりカンター、その日の島の外からの訪問者数も保持します。

### 3. 自由な花畑のかたちと、スペース効率の検証

        シミュレーションに使う基本の花畑は、縦横の大きさを自由に設定できる長方形です。
        さらに、カバー（スコップで掘れない地面や柵に相当）を配置することで自由な形が作れます。

        本作では、1日の花の交配数に上限がないので、植え込みスペースを広げれば交配数は増えます。
        そのため、手法の比較には、スペースの使用量を揃える必要があります。
        ペアの交配を行う場合、5x3のフィールドに4組植える構成が、実際の水やり（「じょうろ」で2回）
        や、交配用の花畑の配置と見栄えからも合理的なので、この5x3の花畑を単位にシミュレーションで
        使用したスペースを確認できるようにしています。

### 4. ユーザーの収穫・移植・水やりを花畑ごとに定義

        基本の花畑はC++のクラスなので、継承して自由にユーザー動作を定義した花畑がつくれます。
        また、以下のような機能はあらかじめ用意されているので、カスタム花畑を連携させたモデルの
        作成も容易におこなえます。
                花の配置順をもつ植込み待ち行列
                収穫した花の色と移植先を定義した収穫計画
                特定の位置、訪問者数を指定した水やり（デフォルトは全体に訪問者なしの水やり）
                日々の更新処理（AM5:00）とそのカウント（経過日数）
        さらに、青バラを作成するためのシミュレーションに使用したカスタム花畑も acnh.h 内に
        提供しているので、流用したり、あらたな花畑を自作する際の参考にできます。

### 5. 多様なシミュレーションに対応するための基本シミュレーター

        標準的なシミュレーションとレグレッション（繰り返し試行と統計）を実装し、シミュレータの
        作成をサポートします。
        基本シミュレーターを継承してカスタマイズすることで、必要な処理だけを追加・変更すること
        が可能です。提供されているシミュレーターからは、あたらしいシミュレーターを作成する際の、
        カスタマイズのヒントが得られます。


## サンプル・シミュレーター

### A. あおバラをつくるためのシミュレーション

        インターネット上に4月に公開された "ACNH Hybrid Guide" に紹介された3つの方法と
        その改良版を実装しています。
        使用スペースは、3x5の花畑で、最大15枚前後に揃うようにサイズを調整しています。
        以下遺伝子は（RYWS）の国際表現で表示しています。（実装はWYRSの日本ローカル表現）

        いずれも以下のコマンドオプションをサポートします
                -r repeat       繰り返しテストの繰り返し回数 (1,000回〜10,000回がおすすめ）
                                指定なしで、各ステップをプリントする1回のシミュレーションを行う
                -v visitor      訪問者数（デフォルト0）

#### 1. BackwardsN Method（bn.cpp）  
        Purple(0120)とOrange(1100)からOrange(1210)を作る方法です。
        Purple側の作成が1世代多くかかるため、一般的な交配方法に濃縮Orange（1200,2100,2200）
        をまぜてPurple(0120)ができやすくするための工程(5.)を加えてあります。
        6.のテストでPurple(0120)と(0020）を判定して、(0120)のみを工程(7.)におくります。
        ここで(0120)の半分は(0120)でないと判定せざるをえないので、効率がよくありません。

                1: Wh_ x Wh_ -> Pu1                     // 25%
                2: Ye_ x Wh_ -> Wh2                     // 50%
                3: Rd_ x Ye_ -> Or3                     // 50%
                4: Wh2 x Pu1 -> Pu4                     // 50%
                5: Or3 x Or3 -> Or5                     // 56.25% (25% Or3, 31.25% condensed Or)
                6: Pu4 x Ye_ -> Ye ? Pu6 : Pu1          // 25%
                7: Pu6 x Or5 -> Or7                     // 22.2% (Or3 x Pu6 -> Or7: 12.5%)
                8: Or7 x Or7 -> Wh8/Rd8/Bu_             // 6.25%/12.5%/6.25%
                9: Rd8 x Rd8 -> Wh8/Rd8/Bu_             // 25%/50%/25%

        訪問者なしで、平均69〜70日（標準偏差約15日）程度の結果が、繰り返しテストでえられます。

#### 2. 軽量化 BackwardsN Method（bn_lite.cpp）  
        1. の BackwardsN Method から、時間のかかるテスト工程(6.)を除いて、その分のスペースを
        他工程にに追加したものです。7:の畑にはPu1とPu6が混ざって植えられますが、そのぶん試行回数は
        増えています。

        効果は意外なほど大きく、平均59〜60日（標準偏差約12日）まで期間を短縮することができます。

#### 3. Pahel Method（ph.cpp）  
        Purple(0120)を自己交配してwhite(0220)を作り、これを核にして、隣に植えたBlack(2000)を
        Rd(1110) -> Or(1210) -> Rd(2210) と濃縮していく、おもしろい交配方法です。
        濃縮の過程ででる花にも、よいものがかなり含まれるので、しっかり再利用しています（X.とY.）

                1: Wh_ x Wh_ -> Pu1                     // 25%
                2: Ye_ x Wh_ -> Wh2                     // 50%
                3: Rd_ x Rd_ -> Bk3                     // 25%
                4: Wh2 x Pu1 -> Pu4                     // 50%
                5: Pu4 x Ye_ -> Ye ? Pu5 : Pu1          // 50%/50%
                6: Pu5 x Pu5 -> Wh6/Pu4                 // 25%/(Pu6:50%,Pu1:25%)
                7: Wh6 x Bk3 -> Rd7 -> Or7 -> Rd8       // Rd7:100%
                                                        // Or7:12.5% (w/ Wh6:12.5%, RdM:)
                                                        // Rd8:25% (w/ Or7:50%, Wh6:25%)
                9: Rd8 x Rd8 -> Bu9/Rd8/Wh6             // 25%/50%/25%
                X: Or7 x Or7 -> Bu9/Rd8/Wh6             // 6.25%/12.5%/6.25%
                Y: RdM x RdM -> Bu9                     // 10.9%

        2.でみたテストの省略による高速化が使えず、核になる白にたどりつくまでに時間がかかりすぎるため、
        他の方法とくらべると結果はかなり見劣りし、平均94〜95日（標準偏差約17日）程度の結果がえられます。

#### 4. Guaranteed Red Method (gr.cpp)  
        Red(1110)を自己交配させて、あおバラをねらう方法です。確率は1/64とかなり低いのですが、
        工程が単純なので、この交配にたどりつくまでが早く、スペースもたくさん使えるメリットがあります。
        Purple(0020)にOrange(1100)を交配してRed(1110)をつくる方法もみかけますが、できる赤の
        半分はRed(1010)になってしまうため、1段階多いものの確実にRed(1110)がつくれる方法を採用
        しています。

                1: Wh_ x Wh_ -> Pu                      // 25%
                2: Rd_ x Rd_ -> Bk2                     // 25%
                3: Pu1 x Bk2 -> Rd3                     // 100%
                4: Ye_ x Rd3 -> Rd4                     // 25%
                5: Rd4 x Rd4 -> Bu5                     // 1.56%

        結果は1.のBackwardsNを超えて、平均63〜64日ですが、さいごのあおバラをつくるところの確率が
        ひくすぎて、運がわるいといつまでもできないことが、標準偏差の20日程度にあらわれています。

#### 5. Guaranteed Red Method (改）(grx.cpp)  
        実は、4.の方法には、5:でできるあお以外の花を再利用するという、効果的な改良方法があります。
        ここで大量にできる、あか、オレンジ、くろのはなそれぞれを自己交配させると、もとのRed(1110)よりも
        少し高い確率であおが咲くので、これも並行してやってしまおうというものです。

                　（1: 〜 4:は 4.のものとおなじ）
                5: Rd4 x Rd4 -> Bu5/Rd5/Or5/Bk5         // 1.56%/40.62%/23.43%/9.37%
                X: Rd5 x Rd5 -> Bu5                     // 2.36%
                Y: Or5 x Or5 -> Bu5                     // 1.78%
                Z: Bk5 x Bk5 -> Bu5                     // 2.78%

        結果からもこの改良が効くことがわかります。平均53〜54日、標準偏差も12日程度と最高の成績です。
        ちなみに、繰り返しテストで表示される使用フィールド単位は20程度と大きく表示されますが、
        この方法を使って花を育てるときには、終盤で必要なくなる1:〜3:の花畑を、徐々にX:〜Z:に
        置き換えることになるので、実際には15単位以下におさえることができます。
        （終盤になっても、雨が降らない日に大量に水やりをしなければならないのがデメリットでしょうか。）


### B. 5x3単位の花畑の花の配置シミュレーション
        あつ森の花の交配システムが面白いのは、たて・よこ・ななめのとなりあった花でランダムにペアを組んで
        交配し、ペアを組めなかった花は自分の複製（クローン）をつくることです。  特にあおバラをねらう場合は、
        このクローンをうまく避けないと、おもった交配とはちがった結果になるので、注意が必要です。  
        また、花の交配順序もランダムで、一つの花の処理は一気に行われるので、acnh.h の特徴でも書いた
        ように、交配で咲いたつぼみを交配に用いると、つぼみが後になった場合は相手がつぼみと交配できずに
        クローンができてしまうといった、順序の抽選による微妙な問題まで発生します。  
        そこで花の配置が、収穫量、スペースの効率、クローンの発生率などにどのような影響を与えるかを検証
        できるようにしました。  

        いずれも以下のコマンドオプションをサポートします
                -a              すべての訪問者数（0〜5）について結果を表示
                -v visitor      特定の訪問者数について結果を表示（デフォルト0）

                -s steps        シミュレーションの日数(1,000日がデフォルト）
                                指定なしで、各ステップをプリントする1回のシミュレーションを行う

                -h              レイアウトサイズを5x5に拡大
                -w              レイアウトサイズを5x7に拡大
                -t              レイアウトサイズを5x11に拡大
                -q              レイアウトサイズを5x15に拡大

#### 1. おなじ遺伝子をもつ花のレイアウト（layout1.cpp）  
        おなじ遺伝子をもつ花は、すべてが、0か2でできている場合は、クローンとおなじものしかできません。
        そこで、White Rose(0010)を使って、Purple Rose(0020)をつくる工程をシミュレートし、クローン
        が目的のPuple Roseの収穫にどう影響するかも含めて調べます。

        レイアウトは下記の7種と、参考として今作ではよくないとされている斜めクロスの配置2種を試します。

        8.      9.      10.     11.     12O.    12H.    13.    |  7X.     8X.
        -----   -----   -----   -----   -----   -----   -----  |  -----   -----
        W - W   W - W   - W -   W W W   W W W   W - W   W W W  |  - W -   W - W
        W - W   W - W   W W W   W - W   W - W   W W W   W - W  |  W - W   - W -
        - - -   - W -   W - W   - W -   W - W   - W -   W W W  |  - W -   W - W
        W - W   W - W   W W W   W - W   W - W   W W W   W - W  |  W - W   - W -
        W - W   W - W   - W -   W W W   W W W   W - W   W W W  |  - W -   W - W

        -a オプションをつかってシミュレートを行うと、毎日の訪問者数によって、どのレイアウトがたくさん
        収穫できるかが変わることがわかります。

        訪問者0の場合は、海外の情報などでも評判のよい 13. の形がもっともよく、ほぼ3日に1輪の割合で
        Purple Rose(0020)を咲かせることができ、8. より50％以上効率がよくなっています。
        また、5x3 で 13. の配置は、クローンも発生しないこと（角を囲む斜めの花が先に交配すると、できた
        花が角のクローンのスペースを奪う）もわかるので、収穫したいものとクローンが同色になる場合でも
        使ことができます。（幅を伸ばして5x5以上にすると、少しだけクローンが発生するようになるので注意）

        訪問者1の場合、12O.が収穫数がもっとも多く、2日に1輪以上の割合でPurple Rose(0020)が咲きます。
        クローンも1％以下に抑えられそうなので、混ざると効率が低下するようなケースでも影響は少なそうです。

        訪問者5の場合は、10.が収穫量がもっとも多く、平均で1日1輪程度Purple Rose(0020)が咲きます。
        ただ、クローンの発生率は6%を超え、8. との差もわずかなので、クローンの色の問題がなく、水やりも
        簡単な 8. を採用するというのもよい選択になりそうです。

        いずれの場合も全収穫数ではなく、植えた花1輪あたりの収穫数では 8. のレイアウトがベストですので、
        工程の途中で発生する花のレイアウトとしては、スペースに余裕があれば、8. がよいこともわかります。

        さらに、前作までひろく用いられていた斜めクロス配置は、とくに角に花がある配置 8X.でクローンの
        発生率が非常にたかく、いずれも収穫量も多くないことから、採用すべきでないことがわかります。
        （蛇足ですが、唯一の例外は、3x3で金のバラを育てるためにくろバラをX型に配置するケースです。
        金のじょうろをつかうと、中央に金のバラを交配するためのフラグが立つので、5輪のうち1つでも交配
        すれば、1回はかならず中央を含む交配が行われ、50％の確率で金のバラがつくれるので効率的です。）

#### 2. ことなる遺伝子をもつ2種類の花のレイアウト（layout2.cpp）  
        2種類の花をかけ合わせるときには、おなじ遺伝子をもつ花どうしが交配しないように、たて・よこ・
        斜めでとなりあう花が、ことなる遺伝子をもつ相手の花になるように配置する必要があります。
        さらに、2種類の配置を逆にすると、できるクローンの色が入れかわるので、レイアウトは1種類のとき
        よりも気を付けなくてはなりません。  
        ここでは、Purple Rose(0120) と Orange Rose(1100) を交配して、Orange Rose(1210)
        を咲かせるケースを例にとって、シミュレーションを行なっています。Orange Rose(1100)のクロー
        ンができると、Orange Rose(1210) と区別がつかないので、これを避ける必要があります。  

        レイアウトは、おなじ遺伝子をもつ花が隣り合うことのない以下の9種を試します。
        （これ以上密度をあげると、のぞまない O x O, P x P の交配が発生してしまいます。）

        7N.     7R.     XN.     XR.     8.      9N.     9R.     LN.     LR.
        -----   -----   -----   -----   -----   -----   -----   -----   -----
        - O -   - P -   O - O   P - P   O - O   O - O   P - P   O - O   P - P
        P - P   O - O   - P -   - O -   P - P   P - P   O - O   P - P   O - O
        - O -   - P -   O - O   P - P   - - -   - O -   - P -   O - O   P - P
        P - P   O - O   - P -   - O -   P - P   P - P   O - O   P - P   O - O
        - O -   - P -   O - O   P - P   O - O   O - O   P - P   O - O   P - P

        このうち、オレンジのクローンができないレイアウトは、7N, XR、8、9R、LRです。

        XN. および XR. は外側に置いた色のクローンの発生率が、訪問者なしで11％前後、訪問者5人だと
        58％前後と桁違いに多く、あらためて本作では、斜めクロス配置がよくないことがわかります。

        収穫数は訪問者数によらず LR. がトップです。訪問者数がふえるにつれ 8. などの成績もよく
        なっていきますが、5人訪問しても LR. を超えるところまではいきませんでした。
        したがって、Orange Rose(1210) を咲かせるなら、LR. の配置がおすすめです。

        もし、交配する2種いずれのクローンも作りたくない場合は、8. のレイアウトを採用することに
        なります。


### C. 水やりと収穫の関係の検証
        花が咲いている状態で水やりをすると、その花はある確率で朝5:00の更新処理のとき交配します。
        この確率は、交配に失敗したときに貯まっていくカウンターによって少しずつ増えていきます。
        カウンターと交配率の関係は、カウンターの最大値20まで以下のとおりです。
        
                0〜3：5％
                4；10％
                5：15％
                ... 5％づつふえる ...
                19：85％
                20：90％
                （訪問者がじょうろで水をかけると、この確率にさらにボーナスがつきます）

        では、訪問者がいない状態で、すでに花まで育っている株に水をかけ続けた場合、平均何日で
        交配が行われるのでしょうか。

        上記で、最初に水をかけた日の翌日に咲いた場合を1日目として、確率を計算すると 6.727日
        になりますが、これをシミュレータを組んで検証すると、ほぼ理論値に近い値が得られます。
        しかし、標準偏差が3日に近い値になるので、かなり運に左右されることもわかります。

        シミュレーターは 1x2 の花畑にあかバラを1輪植えて実行するように設計しており、acnh.h
        のユーティリティ群をつかうもっとも簡単なサンプルになっています。

        コマンドオプションは、以下のとおりです。
                -v 訪問者数                                （0..5、デフォルト0)
                -t シミュレーションを終わるための交配数         （デフォルト1)
                -s 繰り返しテストではなく1回シミュレーションを行う
                繰り返しテストの回数                         （省略した場合は1000）

## 構成ファイル

        ./                              導入ディレクトリ
        ./acnh.h                        ユーティリティ
        ./include/pctl/plist.h          生ポインタ用のシングルリンクリスト・コンテナ
        ./include/pctl/pcontainer.h
        ./makefile                      サンプル・シミュレーターのメークファイル
        ./makefile.inc                  makefileが読み込む開発環境の定義ファイル
        ./bn.cpp                        サンプルシミュレーター
        ./bn_lite.cpp
        ./ph.cpp
        ./gr.cpp
        ./grx.cpp
        ./layout1.cpp
        ./layout2.cpp
        ./reprod.cpp
        ./misc                          雑多なシミュレーターやテスト用のコード
        ./README.txt                    このファイル


## 導入

        acnh_FFS.tgz をダウンロードし、適当なディレクトリをつくって、そこに展開してください。
        
        C++ は ClangまたはGCCを想定しています。
        必要に応じて makefile.inc を編集してください。
        
        引数なしの make コマンドでサンプル・シミュレーターがコンパイルされます。
        
        
